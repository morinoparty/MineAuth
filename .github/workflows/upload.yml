name: upload_release

on:
  release:
    types: [ published ]

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_ACTOR: ${{ secrets.GITHUB_ACTOR }}

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: 'temurin'
          java-version: '21'

      # Gradle キャッシュの設定（setup-gradle を使用）
      - uses: gradle/actions/setup-gradle@8379f6a1328ee0e06e2bb424dadb7b159856a326 # v4.4.0

      - name: Change wrapper permissions
        run: chmod +x ./gradlew

      - name: Set version env
        run: |
          before="${{ github.event.release.tag_name }}"
          after="${before//v/}"
          echo "PLUGIN_VERSION=$after" >> $GITHUB_ENV

      - name: change plugin.yml version
        run: |
          echo "バージョンは ${{ env.PLUGIN_VERSION }} なのだ！"
          sed -i "s/VersionPlaceholder/${{ env.PLUGIN_VERSION }}/" ./gradle.properties

      # Core と Addons を並列ビルド
      - name: Build with Gradle (parallel)
        run: ./gradlew build -x test --parallel

      # Maven CentralへAPIモジュールを公開
      - name: Publish API to Maven Central
        run: ./gradlew :api:publishAndReleaseToMavenCentral
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_PUBLISH_MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_PUBLISH_MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.MAVEN_PUBLISH_GPG_PRIVATE_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.MAVEN_PUBLISH_GPG_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.MAVEN_PUBLISH_GPG_PASSPHRASE }}

      # ファイル名を変更
      - name: Rename artifacts
        run: |
          mv ./core/build/libs/core-*-all.jar ./core/build/libs/MineAuth-core_${{ env.PLUGIN_VERSION }}.jar

          # 動的にすべてのaddonを検出してリネーム
          for addon_dir in ./addons/*/; do
            addon_name=$(basename "$addon_dir")
            jar_file=$(find "${addon_dir}build/libs/" -name "${addon_name}-*-all.jar" 2>/dev/null | head -1)
            if [ -n "$jar_file" ]; then
              mv "$jar_file" "${addon_dir}build/libs/MineAuth-addon-${addon_name}-${{ env.PLUGIN_VERSION }}.jar"
              echo "Renamed addon: ${addon_name}"
            else
              echo "No JAR found for addon: ${addon_name}"
            fi
          done

      # GitHub Attestations で署名（Core）
      - name: Attest Core JAR artifact
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: './core/build/libs/MineAuth-core_${{ env.PLUGIN_VERSION }}.jar'

      # GitHub Attestations で署名（Addons - 動的に検出）
      - name: Attest Addon JAR artifacts
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: './addons/*/build/libs/MineAuth-addon-*-${{ env.PLUGIN_VERSION }}.jar'

      # Core を Modrinth と GitHub にアップロード
      - uses: Kir-Antipov/mc-publish@995edadc13559a8b28d0b7e6571229f067ec7659 # v3.3.0
        with:
          modrinth-id: 9LoU3yUC
          modrinth-featured: true
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-draft: false
          files: |
            ./core/build/libs/MineAuth-core_${{ env.PLUGIN_VERSION }}.jar
            ./addons/*/build/libs/MineAuth-addon-*-${{ env.PLUGIN_VERSION }}.jar
          loaders: |
            paper
            purpur
          game-versions: |
            >=1.21.8
          game-version-filter: releases
          dependencies: |
            LuckPerms(required){modrinth:Vebnzrzj}
            QuickShop-Hikari(optional){modrinth:ijC5dDkD}
            Vault(optional)
          java: |
            21

      # Addons を GitHub リリースにのみアップロード（動的に検出）
      - name: Upload Addons to GitHub Release
        run: |
          gh release upload ${{ github.event.release.tag_name }} \
            ./addons/*/build/libs/MineAuth-addon-*-${{ env.PLUGIN_VERSION }}.jar \
            --clobber

