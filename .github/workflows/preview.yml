name: preview.yml
on:
  pull_request:
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: write
  actions: read
  id-token: write

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_EC2_METADATA_DISABLED: true
  AWS_REGION: auto
  AWS_CLI_FILE_ENCODING: UTF-8
  AWS_DEFAULT_S3_SIGNATURE_VERSION: s3v4
  S3_UPLOAD_BUCKET: ${{ secrets.S3_UPLOAD_BUCKET }}
  S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
  PREVIEW_BASE_URL: https://moripa-ci.nikomaru.dev/mineauth
  PROJECT_NAME: MineAuth

jobs:
  # å…±é€šã®å‰å‡¦ç†ï¼šã‚³ãƒŸãƒƒãƒˆSHAã‚’å–å¾—
  setup:
    runs-on: ubuntu-latest
    outputs:
      commit_sha: ${{ steps.vars.outputs.commit_sha }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set short git commit SHA
        id: vars
        run: |
          calculatedSha=$(git rev-parse --short HEAD)
          echo "commit_sha=$calculatedSha" >> $GITHUB_OUTPUT

  # Gradle ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–ï¼ˆdocs ã¨ä¸¦åˆ—å®Ÿè¡Œï¼‰
  build-gradle:
    needs: setup
    runs-on: ubuntu-latest
    outputs:
      test_total: ${{ steps.publish-test-results.outputs.total }}
      test_passed: ${{ steps.publish-test-results.outputs.passed }}
      test_skipped: ${{ steps.publish-test-results.outputs.skipped }}
      test_failed: ${{ steps.publish-test-results.outputs.failed }}
      hashes: ${{ steps.hash.outputs.hashes }}
    env:
      COMMIT_SHORT_SHA: ${{ needs.setup.outputs.commit_sha }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: 'temurin'
          java-version: '21'

      # Gradle ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®šï¼ˆsetup-gradle ã‚’ä½¿ç”¨ï¼‰
      - uses: gradle/actions/setup-gradle@8379f6a1328ee0e06e2bb424dadb7b159856a326 # v4.4.0
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/master' }}

      - name: Change wrapper permissions
        run: chmod +x ./gradlew

      - name: change plugin.yml version
        run: |
          sed -i "s/VersionPlaceholder/${{ env.COMMIT_SHORT_SHA }}/" ./gradle.properties

      - name: Build with Gradle
        continue-on-error: true
        run: ./gradlew build

      - name: Publish test results
        id: publish-test-results
        uses: mikepenz/action-junit-report@e08919a3b1fb83a78393dfb775a9c37f17d8eea6 # v6.0.1
        if: success() || failure()
        with:
          report_paths: './**/build/test-results/test/TEST-*.xml'

      - name: Prepare Gradle artifacts
        run: |
          mkdir -p ./gradle-artifacts/jars
          mkdir -p ./gradle-artifacts/junit
          mkdir -p ./gradle-artifacts/detekt
          mv ./core/build/libs/core-*-all.jar ./gradle-artifacts/jars/${{ env.PROJECT_NAME }}-core-${{ env.COMMIT_SHORT_SHA }}.jar
          mv ./api/build/libs/api-*.jar ./gradle-artifacts/jars/${{ env.PROJECT_NAME }}-api-${{ env.COMMIT_SHORT_SHA }}.jar
          mv ./addons/quickshop-hikari/build/libs/quickshop-hikari-*-all.jar ./gradle-artifacts/jars/${{ env.PROJECT_NAME }}-quickshop-hikari-${{ env.COMMIT_SHORT_SHA }}.jar || echo "No quickshop-hikari JAR"
          cp -r ./core/build/reports/tests/test/* ./gradle-artifacts/junit/ || echo "No JUnit reports found"
          cp -r ./build/reports/detekt/* ./gradle-artifacts/detekt/

      # SLSAç”¨ã®ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆ
      - name: Generate hashes for SLSA
        id: hash
        shell: bash
        run: |
          cd ./gradle-artifacts/jars
          echo "hashes=$(sha256sum *.jar | base64 -w0)" >> "$GITHUB_OUTPUT"

      # JAR ã‚’ GitHub Artifacts ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆSLSA Level 3å¯¾å¿œï¼‰
      - name: Upload JAR artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: mineauth-jars-${{ env.COMMIT_SHORT_SHA }}
          path: ./gradle-artifacts/jars/*.jar
          retention-days: 7

      # ãƒ¬ãƒãƒ¼ãƒˆã¯ä¸€æ™‚ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿æŒï¼ˆS3ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
      - name: Prepare report artifacts for upload
        run: |
          mkdir -p ./report-artifacts
          cp -r ./gradle-artifacts/junit ./report-artifacts/ || echo "No JUnit reports"
          cp -r ./gradle-artifacts/detekt ./report-artifacts/ || echo "No Detekt reports"

      - name: Upload report artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: report-artifacts
          path: ./report-artifacts
          retention-days: 1

  # SLSA Level 3 Provenance ç”Ÿæˆã‚¸ãƒ§ãƒ–
  provenance:
    needs: [setup, build-gradle]
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.build-gradle.outputs.hashes }}"
      upload-assets: false
      provenance-name: "mineauth-${{ needs.setup.outputs.commit_sha }}.intoto.jsonl"

  # Docs ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–ï¼ˆgradle ã¨ä¸¦åˆ—å®Ÿè¡Œï¼‰
  build-docs:
    needs: setup
    runs-on: ubuntu-latest
    env:
      COMMIT_SHORT_SHA: ${{ needs.setup.outputs.commit_sha }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: 'temurin'
          java-version: '21'

      # Gradle ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®šï¼ˆDokka ç”Ÿæˆç”¨ï¼‰
      - uses: gradle/actions/setup-gradle@8379f6a1328ee0e06e2bb424dadb7b159856a326 # v4.4.0
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/master' }}

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '22'

      - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
        name: Install pnpm
        with:
          version: 10
          run_install: false

      # pnpm ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        name: Setup pnpm cache
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Change wrapper permissions
        run: chmod +x ./gradlew

      - name: Configure Fumadocs for preview
        run: |
          cd docs
          # Update basePath for preview deployment
          sed -i "s#basePath: ''#basePath: '/mineauth/${{ env.COMMIT_SHORT_SHA }}/docs'#g" next.config.mjs

      - name: Install docs dependencies
        working-directory: docs
        run: pnpm install

      - name: Generate Dokka API documentation
        run: ./gradlew dokkaGenerate

      - name: TypeSpec
        working-directory: typespec
        run: |
          pnpm install
          pnpm compile

      - name: Build Fumadocs
        working-directory: docs
        run: pnpm run build

      - name: Upload docs artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: docs-artifacts
          path: ./docs/out
          retention-days: 1

  # S3 ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¸ãƒ§ãƒ–ï¼ˆDocs ã¨ ãƒ¬ãƒãƒ¼ãƒˆã®ã¿ã€JAR ã¯ GitHub Artifactsï¼‰
  upload-s3:
    needs: [setup, build-gradle, build-docs]
    runs-on: ubuntu-latest
    env:
      COMMIT_SHORT_SHA: ${{ needs.setup.outputs.commit_sha }}
    steps:
      - name: Download report artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: report-artifacts
          path: ./upload

      - name: Download docs artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: docs-artifacts
          path: ./upload/docs

      - name: Upload to S3 (parallel)
        run: |
          # AWS CLIã®ä¸¦åˆ—ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’å¢—ã‚„ã™
          aws configure set default.s3.max_concurrent_requests 50

          S3_BASE="s3://${{ env.S3_UPLOAD_BUCKET }}/mineauth/${{ env.COMMIT_SHORT_SHA }}"
          S3_OPTS="--endpoint-url ${S3_ENDPOINT} --only-show-errors"

          # Docs ã¨ ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¸¦åˆ—ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆJAR ã¯ GitHub Artifacts ã‚’ä½¿ç”¨ï¼‰
          aws s3 cp ./upload/junit $S3_BASE/junit $S3_OPTS --recursive &
          aws s3 cp ./upload/detekt $S3_BASE/detekt $S3_OPTS --recursive &
          aws s3 cp ./upload/docs $S3_BASE/docs $S3_OPTS --recursive &

          # å…¨ã¦ã®ä¸¦åˆ—ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å¾…æ©Ÿ
          wait
          echo "S3 upload completed"

  # ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆã‚¸ãƒ§ãƒ–
  comment:
    needs: [setup, build-gradle, upload-s3, provenance]
    runs-on: ubuntu-latest
    if: ${{ github.event.action == 'opened' || github.event.action == 'synchronize' }}
    env:
      COMMIT_SHORT_SHA: ${{ needs.setup.outputs.commit_sha }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Get limit time
        id: limit-time
        run: |
          limit_time=$(date -d "7 days" +%Y-%m-%d)
          echo "LIMIT_TIME=$limit_time" >> $GITHUB_ENV

      - name: Create comment file
        env:
          # JAR ã¯ GitHub Artifacts ã‚’ä½¿ç”¨ï¼ˆSLSA Level 3å¯¾å¿œï¼‰
          ARTIFACT_RUN_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # Docs ã¨ ãƒ¬ãƒãƒ¼ãƒˆã¯ S3 ã‚’ä½¿ç”¨
          JUNIT_REPORT_URL: "${{ env.PREVIEW_BASE_URL }}/${{ env.COMMIT_SHORT_SHA }}/junit/index.html"
          DETEKT_REPORT_URL: "${{ env.PREVIEW_BASE_URL }}/${{ env.COMMIT_SHORT_SHA }}/detekt/detekt.html"
          DOCS_PREVIEW_URL: "${{ env.PREVIEW_BASE_URL }}/${{ env.COMMIT_SHORT_SHA }}/docs/index.html"
          DOKKA_URL: "${{ env.PREVIEW_BASE_URL }}/${{ env.COMMIT_SHORT_SHA }}/docs/dokka/index.html"
          OPENAPI_URL: "${{ env.PREVIEW_BASE_URL }}/${{ env.COMMIT_SHORT_SHA }}/docs/openapi/index.html"
          LIMIT_TIME: ${{ env.LIMIT_TIME }}
        run: |
          cat  << EOF > comment.md
          ## ğŸš€ Preview of ${{ github.event.repository.name }}
          This preview is available for 7 days. (until $LIMIT_TIME)

          ### ğŸ“¦ JAR Artifacts (SLSA Level 3)
          Download JARs from GitHub Artifacts: [Actions Run]($ARTIFACT_RUN_URL)
          - MineAuth-core-${{ env.COMMIT_SHORT_SHA }}.jar
          - MineAuth-api-${{ env.COMMIT_SHORT_SHA }}.jar
          - MineAuth-quickshop-hikari-${{ env.COMMIT_SHORT_SHA }}.jar

          > **SLSA Level 3 Provenance** is included with the artifacts.

          ### ğŸ“– Documentation & Reports
          <table>
            <tr>
              <th scope="row">ğŸ“– Documentation Preview</th>
              <td><a href="$DOCS_PREVIEW_URL">$DOCS_PREVIEW_URL</a></td>
            </tr>
            <tr>
              <th scope="row">ğŸ“– Dokka API Documentation</th>
              <td><a href="$DOKKA_URL">$DOKKA_URL</a></td>
            </tr>
            <tr>
              <th scope="row">ğŸ“– OpenAPI Documentation</th>
              <td><a href="$OPENAPI_URL">$OPENAPI_URL</a></td>
            </tr>
            <tr>
              <th scope="row">ğŸ§ª JUnit Report</th>
              <td><a href="$JUNIT_REPORT_URL">$JUNIT_REPORT_URL</a></td>
            </tr>
            <tr>
              <th scope="row">ğŸ” Detekt Report</th>
              <td><a href="$DETEKT_REPORT_URL">$DETEKT_REPORT_URL</a></td>
            </tr>
          </table>

          ### ğŸ§ª Test Summary

          | Tests ğŸ’¯ | Passed âœ… | Skipped â­ï¸ | Failed âŒ |
          |----------|-----------|------------|----------|
          | ${{ needs.build-gradle.outputs.test_total }} ran | ${{ needs.build-gradle.outputs.test_passed }} passed | ${{ needs.build-gradle.outputs.test_skipped }} skipped | ${{ needs.build-gradle.outputs.test_failed }} failed |
          EOF

      - name: Create PR comment
        run: gh pr comment ${{ github.event.number }} --body-file comment.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
